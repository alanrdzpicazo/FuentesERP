using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using ProbeMedic.AppCode.BLL;

namespace ProbeMedic.VENTAS
{
    public partial class Frm_Cancelacion_Venta : Forma
    {
        SQLVentas sql_ventas = new SQLVentas();

        DataTable dtVentas = new DataTable();

        DataTable dtDatos = new DataTable();
        public DataTable DetalleCancelacion_Venta_Type
        {
            get
            {
                System.Data.DataTable dt = new DataTable();
                dt.Columns.Add("K_Almacen", (typeof(int)));
                dt.Columns.Add("K_Precierre_Empleado", (typeof(int)));
                dt.Columns.Add("K_Usuario", (typeof(int)));
                dt.Columns.Add("K_Transaccion", (typeof(int)));
                dt.Columns.Add("Cantidad_Cancelada", (typeof(int)));
                dt.Columns.Add("K_Articulo", (typeof(int)));
                dt.Columns.Add("Lote", (typeof(string)));
                dt.Columns.Add("F_Caducidad", (typeof(string)));
                dt.Columns.Add("Monto_Total", (typeof(decimal)));
                dt.Columns.Add("Precio_Unitario", (typeof(decimal)));
                return dt;
            }
        }

        string Detalle_Articulos = string.Empty;
        public Frm_Cancelacion_Venta()
        {
            InitializeComponent();
        }
        private void Frm_Cancelacion_Venta_Load(object sender, EventArgs e)
        {
         
        }
        private void Txt_Folio_KeyDown(object sender, KeyEventArgs e)
        {
            if ((e.KeyCode == Keys.Enter) || (e.KeyCode ==Keys.Tab))
            {
                if (Txt_Folio.Text.Trim().Length == 0)
                {
                    MessageBox.Show("CAPTURE UN NUMERO DE FOLIO. ", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    Txt_Folio.Focus();
                    return;
                }

                dtVentas = sql_ventas.Gp_Consulta_Venta(Convert.ToInt32(Txt_Folio.Text.Trim()));
                if (dtVentas != null)
                {
                    dtVentas.Columns.Add(new DataColumn("Cantidad_Cancelacion", typeof(decimal)));

                    foreach (DataRow row in dtVentas.Rows)
                    {

                        if (row["Cantidad_Cancelacion"] == DBNull.Value)
                        {
                            row["Cantidad_Cancelacion"] = 0;
                        }
                    }
                    Dgv_Datos.DataSource = dtVentas;
                    this.Txt_Usuario.Text = "[" + dtVentas.Rows[0].ItemArray[4].ToString() + "] " + dtVentas.Rows[0].ItemArray[5].ToString();
                    this.Txt_Almacen.Text = "[" + dtVentas.Rows[0].ItemArray[1].ToString() + "] " + dtVentas.Rows[0].ItemArray[2].ToString();
                    this.Txt_Cliente.Text = dtVentas.Rows[0].ItemArray[12].ToString();        
                    this.Lbl_Fecha.Text = dtVentas.Rows[0].ItemArray[6].ToString();
                    this.Lbl_Total.Text = dtVentas.Rows[0].ItemArray[7].ToString();
                    Dgv_Datos.ClearSelection();
                    Txt_Observaciones.Focus();

                    Dgv_Datos.EditMode = DataGridViewEditMode.EditOnEnter;
                    if (Dgv_Datos.Rows.Count > 0)
                    {
                        Dgv_Datos.Rows[0].Cells["Cantidad_Cancelacion"].Selected = true;
                        Dgv_Datos.Focus();
                    }
                }
                else
                {
                    MessageBox.Show("EL FOLIO [" + Txt_Folio.Text.Trim() + "] NO SE HA REGISTRADO COMO TRANSACCION. ", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    Txt_Folio.Focus();
                    return;
                }
            }
        }

        private void BtnLimpiar_Click(object sender, EventArgs e)
        {
            Txt_Folio.Text = string.Empty;
            Txt_Usuario.Text = string.Empty;
            Txt_Almacen.Text = string.Empty;
            Txt_Cliente.Text = string.Empty;
            Lbl_Fecha.Text = "_____________________";
            Lbl_Total.Text = "________";
            dtVentas.Rows.Clear();
            Dgv_Datos.DataSource = dtVentas;
            Txt_Folio.Focus();
        }

        private void Txt_Folio_PreviewKeyDown(object sender, PreviewKeyDownEventArgs e)
        {
            if (e.KeyCode == Keys.Tab)
            {
                if ((e.KeyCode == Keys.Enter) || (e.KeyCode == Keys.Tab))
                {
                    if (Txt_Folio.Text.Trim().Length == 0)
                    {
                        MessageBox.Show("CAPTURE UN NUMERO DE FOLIO. ", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        Txt_Folio.Focus();
                        return;
                    }

                    dtVentas = sql_ventas.Gp_Consulta_Venta(Convert.ToInt32(Txt_Folio.Text.Trim()));

                    if (dtVentas != null)
                    {
                        dtVentas.Columns.Add(new DataColumn("Cantidad_Cancelacion", typeof(decimal)));

                        foreach (DataRow row in dtVentas.Rows)
                        {
                            
                            if (row["Cantidad_Cancelacion"] == DBNull.Value)
                            {
                                row["Cantidad_Cancelacion"] = 0;
                            }
                        }
                        Dgv_Datos.DataSource = dtVentas;
                        this.Txt_Usuario.Text = "[" + dtVentas.Rows[0].ItemArray[4].ToString() + "] " + dtVentas.Rows[0].ItemArray[5].ToString();
                        this.Txt_Almacen.Text = "[" + dtVentas.Rows[0].ItemArray[1].ToString() + "] " + dtVentas.Rows[0].ItemArray[2].ToString();
                        this.Txt_Cliente.Text = dtVentas.Rows[0].ItemArray[12].ToString();
                        this.Lbl_Fecha.Text = dtVentas.Rows[0].ItemArray[6].ToString();
                        this.Lbl_Total.Text = dtVentas.Rows[0].ItemArray[7].ToString();
                        Dgv_Datos.ClearSelection();
                        Txt_Observaciones.Focus();
                    }
                    else
                    {
                        MessageBox.Show("EL FOLIO [" + Txt_Folio.Text.Trim() + "] NO SE HA REGISTRADO COMO TRANSACCION. ", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        Txt_Observaciones.Focus();
                        return;
                    }
                }
            }
        }

        private void Txt_Folio_KeyPress(object sender, KeyPressEventArgs e)
        {
            Funciones fx = new Funciones();
            fx.ValidaSeaNumero(ref e);
        }

        private void Frm_Cancelacion_Venta_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.F3)
            {
                BtnLimpiar.PerformClick();
            }
            if (e.KeyCode == Keys.F4)
            {
               BtnCancelar.PerformClick();
            }
        }

        private void BtnCancelar_Click(object sender, EventArgs e)
        {
        
            string msg = string.Empty;
            int res = 0;
            DataTable dtDetalle = Mtd_Detalle_Cancelacion();

            DialogResult dlg = MessageBox.Show("SERAN CANCELADOS LOS SIGUIENTES ARTICULOS: " +Detalle_Articulos + " \n¿DESEA CONTINUAR?", "Pregunta", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
            if (dlg == DialogResult.Yes)
            {
                res = sql_ventas.Gp_Cancela_Venta(Convert.ToInt32(Txt_Folio.Text.Trim()), Txt_Observaciones.Text.Trim(),dtDetalle, ref msg);
                if (res == -1)
                {
                    MessageBox.Show(msg, "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }
                else
                {
                    MessageBox.Show("SE CANCELO LA TRANSACCION CORRECTAMENTE CON NUMERO DE FOLIO [" + Txt_Folio.Text + "]...!", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    BtnLimpiar.PerformClick();
                }
            }
            else
            {
                return;
            }
                
        }
     
        private void Dgv_Datos_EditingControlShowing(object sender, DataGridViewEditingControlShowingEventArgs e)
        {
            DataGridViewTextBoxEditingControl text = (DataGridViewTextBoxEditingControl)e.Control;
            text.KeyPress -= new KeyPressEventHandler(textbox_KeyPress);
            text.KeyPress += new KeyPressEventHandler(textbox_KeyPress);
        }


        private void textbox_KeyPress(object sender, KeyPressEventArgs e)
        {
            e.KeyChar = char.ToUpper(e.KeyChar);
            if (Char.IsNumber(e.KeyChar) || e.KeyChar == (Char)Keys.Back)
            {
                e.Handled = false;
            }
            else
            {
                e.Handled = true;
            }
        }

        private void Dgv_Datos_CellValidating(object sender, DataGridViewCellValidatingEventArgs e)
        {
            DataGridViewRow row = Dgv_Datos.CurrentRow;

            if (Dgv_Datos == null)
            {
                return;
            }
            if (Dgv_Datos.CurrentRow == null)
            {
                return;
            }
            if (e.ColumnIndex == 27) //cantidad a cancelar
            {
                if (((DataGridView)sender).CurrentCell.GetEditedFormattedValue(e.RowIndex, DataGridViewDataErrorContexts.Display).ToString() == "")
                {
                    Dgv_Datos.CancelEdit();
                    return;
                }

                if (!EsNumero(((DataGridView)sender).CurrentCell.GetEditedFormattedValue(e.RowIndex, DataGridViewDataErrorContexts.Display).ToString()))
                {
                    Dgv_Datos.CancelEdit();
                    return;
                }
                if (row != null)
                {
                    if (Convert.ToDecimal(row.Cells["Cantidad_Articulos"].Value) < Convert.ToDecimal(((DataGridView)sender).CurrentCell.GetEditedFormattedValue(e.RowIndex, DataGridViewDataErrorContexts.Display).ToString()))
                    {
                        MessageBox.Show("LA CANTIDAD A CANCELAR NO PUEDE SER MAYOR A LA CANTIDAD DE LA TRANSACCION, VERIFIQUE...!", "Aviso", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        Dgv_Datos.CancelEdit();
                        return;
                    }
                }
            }
        }

        private void Dgv_Datos_CellValidated(object sender, DataGridViewCellEventArgs e)
        {

        }

        public DataTable Mtd_Detalle_Cancelacion()
        {
            Detalle_Articulos = string.Empty;
            DataTable dtDatos = new DataTable();
            dtDatos = DetalleCancelacion_Venta_Type;

            int row_K_Almacen = 0;
            int row_K_Precierre_Empleado = 0;
            int row_K_Usuario = 0;
            int row_K_Transaccion = 0;
            int row_Cantidad_Cancelada = 0;
            int row_K_Articulo = 0;
            string row_Lote = string.Empty;
            string row_F_Caducidad = string.Empty;
            decimal row_Monto_Total = 0;
            decimal row_Precio_Unitario = 0;
        
            foreach (DataGridViewRow row in Dgv_Datos.Rows)
            {
                if(int.Parse(row.Cells["Cantidad_Cancelacion"].Value.ToString()) >0)
                {
                    row_K_Almacen = int.Parse(row.Cells["K_Almacen"].Value.ToString());
                    row_K_Precierre_Empleado = int.Parse(row.Cells["K_Precierre_Empleado"].Value.ToString());
                    row_K_Usuario = Convert.ToInt32(GlobalVar.K_Usuario);
                    row_K_Transaccion = Convert.ToInt32(row.Cells["K_Transaccion"].Value.ToString());
                    row_Cantidad_Cancelada = Convert.ToInt32(row.Cells["Cantidad_Cancelacion"].Value.ToString());
                    row_K_Articulo = Convert.ToInt32(row.Cells["K_Articulo"].Value.ToString());
                    row_Lote = row.Cells["Lote"].Value.ToString();
                    row_F_Caducidad =row.Cells["F_Caducidad"].Value.ToString();
                    row_Monto_Total = Convert.ToDecimal(row.Cells["Monto_Total"].Value.ToString());
                    row_Precio_Unitario = Convert.ToDecimal(row.Cells["Precio_Unitario"].Value.ToString());
                    
                    Detalle_Articulos+= row.Cells["D_Articulo"].Value.ToString()+" | LOTE:"+ row.Cells["Lote"].Value.ToString()+". \n";
                    dtDatos.Rows.Add(row_K_Almacen, row_K_Precierre_Empleado, row_K_Usuario, row_K_Transaccion, row_Cantidad_Cancelada, row_K_Articulo, row_Lote, row_F_Caducidad, row_Monto_Total, row_Precio_Unitario);

                }
            }
            return dtDatos;
    
        }
    }
}
